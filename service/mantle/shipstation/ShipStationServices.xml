<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <!--set#GetCall Service gets data from oms find#Orders service and modify the data for Orders.xml screen-->
    <service verb="set" noun="GetCall">
        <in-parameters>
            <parameter name="statusId"/>
            <parameter name="start_date" type="Timestamp" format="yyyy-MM-dd">
                <description>Find orders placed at or after this date.</description>
            </parameter>
            <parameter name="end_date" type="Timestamp" format="yyyy-MM-dd">
                <description>Find orders placed at or before this date.</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="orderParts"/>
        </out-parameters>
        <actions>
            <set field="requestMap" from="placedDateStart:start_date, placedDateEnd:end_date, statusId:statusId" type="NewMap"/>
            <set field="orderParts" from="[]"/>
            <service-call name="co.hotwax.oms.OrderServices.find#Orders" in-map="requestMap" out-map="responseMap"/>
            <iterate list="responseMap.orders" entry="order">
                <iterate list="order.order_parts" entry="order_part">
                    <entity-find entity-name="mantle.account.payment.Payment" list="paymentList">
                        <econdition field-name="orderId" from="order.orderId"/>
                        <econdition field-name="orderPartSeqId"  from="order_part.id" or-null="true"/>
                    </entity-find>
                    <if condition="paymentList">
                        <entity-find entity-name="mantle.account.method.PaymentMethod" list="paymentMethodList">
                            <econdition field-name="paymentMethodId" operator="in" from="paymentList*.paymentMethodId"/>
                        </entity-find>
                    </if>
                    <script>
                        order_part.put("orderId", order.orderId)
                        order_part.put("orderName", order.orderName)
                        order_part.put("currencyUom", order.currencyUom)
                        order_part.put("placedDate", order.placedDate)
                        order_part.put("paymentMethod", paymentMethodList?.paymentMethodTypeEnumId)
                        order_part.put("billing_details", order.billing_details)
                        order_part.put("customer_details", order.customer_details)
                    </script>
                    <iterate list="order_part.item_details" entry="item">
                        <service-call name="co.hotwax.oms.ProductServices.find#Products" in-map="[productId:item.productId]" out-map="productFeatureList"/>
                        <script>
                            item.put("features",productFeatureList.products[0].features)
                        </script>
                    </iterate>
                    <script>
                        orderParts.add(order_part)
                    </script>
                </iterate>
            </iterate>
        </actions>
    </service>

    <!--get#Data Service for getting XML data from screen-->
    <service verb="get" noun="Data">
        <in-parameters>
            <parameter name="start_date" type="Timestamp" format="yyyy-MM-dd">
                <description>Find orders placed at or after this date.</description>
            </parameter>
            <parameter name="end_date" type="Timestamp" format="yyyy-MM-dd">
                <description>Find orders placed at or before this date.</description>
            </parameter>
        </in-parameters>
        <actions>
            <script><![CDATA[
                def bodyRender = ec.screen.makeRender().rootScreen("component://mantle-shipstation/screen/Orders.xml").webappName("webroot").renderMode("xml")
                String bodytxt = bodyRender.render()
                System.out.println("====bodytxt====="+bodytxt+"==========")
                System.out.println("====response====="+ec.web.getResponse()+"==========")

                def response = ec.web.getResponse();
                response.setContentType("application/xml")
                Writer w = response.getWriter()
                System.out.println("========="+w+"==========")
                //w.write(bodytxt)
                w.write("<?xml version=\"1.0\" encoding=\"utf-8\"?>")
                w.write(bodytxt)
                w.flush()
                System.out.println("========="+ec.web.getResponse()+"==========")
            ]]>
            </script>
        </actions>
    </service>
</services>